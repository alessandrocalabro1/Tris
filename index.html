<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tris Ultimate</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --container-bg: #1e293b;
            --text-color: #f8fafc;
            --accent-x: #38bdf8; /* Sky Blue */
            --accent-o: #f472b6; /* Pink */
            --grid-line: #334155;
            --hover-cell: #334155;
            --win-glow: 0 0 20px rgba(255, 255, 255, 0.5);
            --font-main: 'Segoe UI', system-ui, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none; /* Prevent text selection */
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .app-container {
            background-color: var(--container-bg);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 480px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            animation: fadeIn 0.6s ease-out;
        }

        h1 {
            text-align: center;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        /* Settings Section */
        .settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            background: rgba(0,0,0,0.2);
            padding: 1rem;
            border-radius: 1rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-size: 0.85rem;
            opacity: 0.8;
            font-weight: 600;
        }

        select {
            background: var(--bg-color);
            color: white;
            border: 1px solid var(--grid-line);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            outline: none;
            font-family: inherit;
        }
        
        select:focus {
            border-color: var(--accent-x);
        }

        /* Status & Score */
        .status-bar {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            min-height: 1.5em;
        }

        .highlight-x { color: var(--accent-x); }
        .highlight-o { color: var(--accent-o); }

        .scores {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            background: rgba(0,0,0,0.2);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
        }

        .score-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .score-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* Game Board */
        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            aspect-ratio: 1;
        }

        .cell {
            background: var(--bg-color);
            border-radius: 1rem;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
        }

        .cell:hover:not(:disabled) {
            background: var(--hover-cell);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        .cell:disabled {
            cursor: default;
        }

        .cell.x { color: var(--accent-x); text-shadow: 0 0 10px rgba(56, 189, 248, 0.4); }
        .cell.o { color: var(--accent-o); text-shadow: 0 0 10px rgba(244, 114, 182, 0.4); }

        .cell.win {
            background: rgba(255, 255, 255, 0.1);
            animation: pulse 1.5s infinite;
        }

        /* Controls */
        .actions {
            display: flex;
            gap: 1rem;
        }

        button.btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-x), #0284c7);
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        button.btn:hover { opacity: 0.9; }
        button.btn:active { transform: scale(0.98); }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.2); }
            70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        .symbol-enter {
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* Responsive */
        @media (max-width: 400px) {
            .app-container { padding: 1rem; }
            .cell { font-size: 2.5rem; border-radius: 0.75rem; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <h1>TRIS ULTIMATE</h1>

    <div class="settings">
        <div class="control-group">
            <label for="game-mode">Modalità</label>
            <select id="game-mode" onchange="resetGame()">
                <option value="pvp">Giocatore vs Giocatore</option>
                <option value="pvcpu">Giocatore vs CPU</option>
            </select>
        </div>
        <div class="control-group" id="difficulty-group" style="display: none;">
            <label for="difficulty">Difficoltà</label>
            <select id="difficulty" onchange="resetGame()">
                <option value="easy">Facile (Random)</option>
                <option value="hard">Difficile (Minimax)</option>
            </select>
        </div>
        <div class="control-group">
            <label for="player-symbol">Il tuo Simbolo</label>
            <select id="player-symbol" onchange="resetGame()">
                <option value="X">Gioca come X (Inizia prima)</option>
                <option value="O">Gioca come O (Inizia dopo)</option>
            </select>
        </div>
    </div>

    <div class="scores" id="scoreboard">
        <div class="score-item">
            <span>X Vince</span>
            <span id="score-x" class="score-value highlight-x">0</span>
        </div>
        <div class="score-item">
            <span>Pareggi</span>
            <span id="score-draw" class="score-value">0</span>
        </div>
        <div class="score-item">
            <span>O Vince</span>
            <span id="score-o" class="score-value highlight-o">0</span>
        </div>
    </div>

    <div class="status-bar" id="status-display" aria-live="polite">
        Tocca a <span class="highlight-x">X</span>
    </div>

    <div class="board" id="board" role="grid">
        <!-- Cells generated by JS -->
    </div>

    <div class="actions">
        <button class="btn btn-primary" onclick="resetGame()" aria-label="Nuova Partita">Nuova Partita</button>
        <button class="btn btn-secondary" onclick="resetScores()" aria-label="Reset Punteggi">Reset Punteggi</button>
    </div>
</div>

<script>
    /* --- State & Config --- */
    const state = {
        board: Array(9).fill(null),
        isGameActive: true,
        currentPlayer: 'X',
        mode: 'pvp', // 'pvp' or 'pvcpu'
        difficulty: 'easy', // 'easy' or 'hard'
        userSymbol: 'X', // 'X' or 'O'
        scores: { X: 0, O: 0, Draw: 0 }
    };

    const winningConditions = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
        [0, 3, 6], [1, 4, 7], [2, 5, 8], // Cols
        [0, 4, 8], [2, 4, 6]             // Diagonals
    ];

    /* --- DOM Elements --- */
    const boardEl = document.getElementById('board');
    const statusEl = document.getElementById('status-display');
    const scoreXEl = document.getElementById('score-x');
    const scoreOEl = document.getElementById('score-o');
    const scoreDrawEl = document.getElementById('score-draw');
    const modeSelect = document.getElementById('game-mode');
    const difficultySelect = document.getElementById('difficulty');
    const difficultyGroup = document.getElementById('difficulty-group');
    const symbolSelect = document.getElementById('player-symbol');

    /* --- Initialization --- */
    function init() {
        // Restore scores from session
        const savedScores = sessionStorage.getItem('trisScores');
        if (savedScores) {
            state.scores = JSON.parse(savedScores);
            updateScoreDisplay();
        }
        
        createBoard();
        attachEventListeners();
        resetGame(false); // don't clear scores
    }

    function createBoard() {
        boardEl.innerHTML = '';
        state.board.forEach((_, i) => {
            const cell = document.createElement('button');
            cell.classList.add('cell');
            cell.dataset.index = i;
            cell.setAttribute('aria-label', `Cella ${i + 1}`);
            cell.addEventListener('click', handleCellClick);
            // Keyboard nav handled natively by button, but check index flow
            cell.tabIndex = 0; 
            boardEl.appendChild(cell);
        });
    }

    function attachEventListeners() {
        modeSelect.addEventListener('change', (e) => {
            state.mode = e.target.value;
            difficultyGroup.style.display = state.mode === 'pvcpu' ? 'flex' : 'none';
            resetGame();
        });

        difficultySelect.addEventListener('change', (e) => {
            state.difficulty = e.target.value;
            resetGame();
        });

        symbolSelect.addEventListener('change', (e) => {
            state.userSymbol = e.target.value;
            resetGame();
        });
    }

    /* --- Game Logic --- */
    function handleCellClick(e) {
        const index = e.target.dataset.index;
        
        if (!state.isGameActive || state.board[index]) return;

        // Player Move
        if (state.mode === 'pvcpu' && state.currentPlayer !== state.userSymbol) return; // Wait during CPU turn

        executeMove(index, state.currentPlayer);

        if (state.isGameActive && state.mode === 'pvcpu' && state.currentPlayer !== state.userSymbol) {
            // CPU Move delay for realism
            setTimeout(cpuMove, 500);
        }
    }

    function executeMove(index, player) {
        state.board[index] = player;
        const cell = boardEl.children[index];
        cell.classList.add(player.toLowerCase(), 'symbol-enter');
        cell.innerText = player;

        if (checkWin()) {
            endGame(false);
        } else if (checkDraw()) {
            endGame(true);
        } else {
            state.currentPlayer = state.currentPlayer === 'X' ? 'O' : 'X';
            updateStatus();
        }
    }

    function updateStatus() {
        if (!state.isGameActive) return;
        
        const isUserTurn = state.mode === 'pvcpu' ? (state.currentPlayer === state.userSymbol) : true;
        const playerClass = state.currentPlayer === 'X' ? 'highlight-x' : 'highlight-o';
        
        let text = `Tocca a <span class="${playerClass}">${state.currentPlayer}</span>`;
        if (state.mode === 'pvcpu') {
             text += isUserTurn ? " (Tu)" : " (CPU)";
        }
        statusEl.innerHTML = text;
    }

    function endGame(isDraw) {
        state.isGameActive = false;
        if (isDraw) {
            statusEl.innerHTML = "Pareggio!";
            state.scores.Draw++;
        } else {
            const winner = state.currentPlayer;
            const playerClass = winner === 'X' ? 'highlight-x' : 'highlight-o';
            statusEl.innerHTML = `Vittoria per <span class="${playerClass}">${winner}!</span>`;
            state.scores[winner]++;
            highlightWinningCells();
        }
        updateScoreDisplay();
        saveScores();
    }

    function highlightWinningCells() {
        const winner = state.currentPlayer;
        for (let condition of winningConditions) {
            const [a, b, c] = condition;
            if (state.board[a] && state.board[a] === state.board[b] && state.board[a] === state.board[c]) {
                boardEl.children[a].classList.add('win');
                boardEl.children[b].classList.add('win');
                boardEl.children[c].classList.add('win');
                return;
            }
        }
    }

    function checkWin(board = state.board, player = state.currentPlayer) {
        return winningConditions.some(combination => {
            return combination.every(index => board[index] === player);
        });
    }

    function checkDraw(board = state.board) {
        return board.every(cell => cell !== null);
    }

    /* --- AI Logic --- */
    function cpuMove() {
        if (!state.isGameActive) return;

        let index;
        if (state.difficulty === 'easy') {
            index = getRandomMove();
        } else {
            index = getBestMove();
        }

        if (index !== -1) {
            executeMove(index, state.currentPlayer);
        }
    }

    function getRandomMove() {
        const available = state.board.map((v, i) => v === null ? i : null).filter(v => v !== null);
        if (available.length === 0) return -1;
        return available[Math.floor(Math.random() * available.length)];
    }

    function getBestMove() {
        // Minimax entry point
        const aiPlayer = state.currentPlayer;
        const huPlayer = aiPlayer === 'X' ? 'O' : 'X';
        let bestScore = -Infinity;
        let move = -1;

        for (let i = 0; i < 9; i++) {
            if (state.board[i] === null) {
                state.board[i] = aiPlayer;
                let score = minimax(state.board, 0, false, aiPlayer, huPlayer);
                state.board[i] = null;
                if (score > bestScore) {
                    bestScore = score;
                    move = i;
                }
            }
        }
        return move;
    }

    const scoresMap = {
        win: 10,
        loss: -10,
        tie: 0
    };

    function minimax(board, depth, isMaximizing, aiPlayer, huPlayer) {
        // Check terminal states
        if (checkWinForPlayer(board, aiPlayer)) return 10 - depth;
        if (checkWinForPlayer(board, huPlayer)) return depth - 10;
        if (checkDraw(board)) return 0;

        if (isMaximizing) {
            let bestScore = -Infinity;
            for (let i = 0; i < 9; i++) {
                if (board[i] === null) {
                    board[i] = aiPlayer;
                    let score = minimax(board, depth + 1, false, aiPlayer, huPlayer);
                    board[i] = null;
                    bestScore = Math.max(score, bestScore);
                }
            }
            return bestScore;
        } else {
            let bestScore = Infinity;
            for (let i = 0; i < 9; i++) {
                if (board[i] === null) {
                    board[i] = huPlayer;
                    let score = minimax(board, depth + 1, true, aiPlayer, huPlayer);
                    board[i] = null;
                    bestScore = Math.min(score, bestScore);
                }
            }
            return bestScore;
        }
    }

    function checkWinForPlayer(board, player) {
         return winningConditions.some(combination => {
            return combination.every(index => board[index] === player);
        });
    }

    /* --- Utilities --- */
    function resetGame(resetScore = false) {
        state.board.fill(null);
        state.isGameActive = true;
        state.currentPlayer = 'X'; // X always starts in standard logic, or based on user choice?
        // Standard rule: X starts. If User picked O, User waits.
        
        // Update UI
        Array.from(boardEl.children).forEach(cell => {
            cell.innerText = '';
            cell.className = 'cell';
            cell.disabled = false;
        });

        // If PvCPU and User is O, CPU (X) must move first
        updateStatus();
        if (state.mode === 'pvcpu' && state.userSymbol === 'O') {
             setTimeout(cpuMove, 500); 
        }
    }

    function resetScores() {
        state.scores = { X: 0, O: 0, Draw: 0 };
        updateScoreDisplay();
        saveScores();
    }

    function updateScoreDisplay() {
        scoreXEl.innerText = state.scores.X;
        scoreOEl.innerText = state.scores.O;
        scoreDrawEl.innerText = state.scores.Draw;
    }

    function saveScores() {
        sessionStorage.setItem('trisScores', JSON.stringify(state.scores));
    }

    // Start
    init();

</script>
</body>
</html>
